[settings]
experimental = true

[tools]
rust = "latest"

[tasks.check]
description = "Fast check: clippy lint only"
run = "mise run lint-fast"

[tasks.test]
description = "Run all tests"
run = """
if ./scripts/cargo-agent.sh nextest --version >/dev/null 2>&1; then
  KEA_ALLOW_WORKSPACE_TESTS=1 ./scripts/cargo-agent.sh nextest run --workspace --lib --tests --bins
else
  THREADS="${KEA_TEST_THREADS:-2}"
  echo "cargo-nextest not installed; using cargo test with ${THREADS} test threads"
  KEA_ALLOW_WORKSPACE_TESTS=1 ./scripts/cargo-agent.sh test --workspace --lib --tests --bins -- --test-threads "${THREADS}"
fi
"""

[tasks.test-changed]
description = "Run tests for changed crates (workspace fallback for root manifest/tooling changes)"
run = "./scripts/test-changed.sh"

[tasks.test-pkg]
description = "Run all tests for one package: PKG=<crate> mise run test-pkg"
run = """
PKG="${PKG:-}"
if [ -z "$PKG" ]; then
  echo "usage: PKG=<crate> mise run test-pkg"
  exit 2
fi
if ./scripts/cargo-agent.sh nextest --version >/dev/null 2>&1; then
  ./scripts/cargo-agent.sh nextest run -p "$PKG" --lib --tests --bins
else
  THREADS="${KEA_TEST_THREADS:-2}"
  echo "cargo-nextest not installed; using cargo test with ${THREADS} test threads"
  ./scripts/cargo-agent.sh test -p "$PKG" --lib --tests --bins -- --test-threads "${THREADS}"
fi
"""

[tasks.test-pkg-integration]
description = "Run integration tests for one package: PKG=<crate> mise run test-pkg-integration"
run = """
PKG="${PKG:-}"
if [ -z "$PKG" ]; then
  echo "usage: PKG=<crate> mise run test-pkg-integration"
  exit 2
fi
if ./scripts/cargo-agent.sh nextest --version >/dev/null 2>&1; then
  ./scripts/cargo-agent.sh nextest run -p "$PKG" --tests
else
  THREADS="${KEA_TEST_THREADS:-2}"
  echo "cargo-nextest not installed; using cargo test with ${THREADS} test threads"
  ./scripts/cargo-agent.sh test -p "$PKG" --tests -- --test-threads "${THREADS}"
fi
"""

[tasks.test-fast]
description = "Run fast unit/bin tests only"
run = """
if ./scripts/cargo-agent.sh nextest --version >/dev/null 2>&1; then
  KEA_ALLOW_WORKSPACE_TESTS=1 ./scripts/cargo-agent.sh nextest run --profile fast --workspace --lib --bins
else
  THREADS="${KEA_TEST_THREADS_FAST:-2}"
  echo "cargo-nextest not installed; using cargo test with ${THREADS} test threads"
  KEA_ALLOW_WORKSPACE_TESTS=1 ./scripts/cargo-agent.sh test --workspace --lib --bins -- --test-threads "${THREADS}"
fi
"""

[tasks.test-soak]
description = "Run a low-parallelism workspace test pass (memory-safe soak profile)"
run = """
if ./scripts/cargo-agent.sh nextest --version >/dev/null 2>&1; then
  KEA_ALLOW_WORKSPACE_TESTS=1 ./scripts/cargo-agent.sh nextest run --profile soak --workspace --lib --tests --bins
else
  THREADS="${KEA_TEST_THREADS_SOAK:-1}"
  echo "cargo-nextest not installed; using cargo test with ${THREADS} test threads"
  KEA_ALLOW_WORKSPACE_TESTS=1 ./scripts/cargo-agent.sh test --workspace --lib --tests --bins -- --test-threads "${THREADS}"
fi
"""

[tasks.test-doc]
description = "Run rustdoc doctests"
run = "KEA_ALLOW_WORKSPACE_TESTS=1 ./scripts/cargo-agent.sh test --workspace --doc"

[tasks.check-full]
description = "Full check including rustdoc doctests"
run = "mise run lint && mise run test && mise run test-doc"

[tasks.fmt]
description = "Format all Rust code"
run = "./scripts/cargo-agent.sh fmt --all"

[tasks.lint]
description = "Run clippy with project lints (workspace, all targets)"
run = "./scripts/cargo-agent.sh clippy --workspace --all-targets -- -D warnings"

[tasks.lint-fast]
description = "Run clippy for changed crates (workspace fallback for root manifest/tooling changes)"
run = "./scripts/lint-changed.sh"

[tasks.sccache-stats]
description = "Show sccache hit/miss stats"
run = """
if command -v sccache >/dev/null 2>&1; then
  sccache --show-stats
else
  echo "sccache not installed"
fi
"""

[tasks.sccache-zero]
description = "Reset sccache stats counters"
run = """
if command -v sccache >/dev/null 2>&1; then
  sccache --zero-stats
else
  echo "sccache not installed"
fi
"""

[tasks.nextest-install]
description = "Install cargo-nextest if missing"
run = """
if ./scripts/cargo-agent.sh nextest --version >/dev/null 2>&1; then
  cargo nextest --version
else
  cargo install cargo-nextest --locked
fi
"""

[tasks.bench]
description = "Run compiler microbenchmarks"
run = "./scripts/cargo-agent.sh bench -p kea-bench --bench core"

[tasks."bench:export"]
description = "Run benchmarks and export stable artifacts (raw + csv + json + meta)"
run = "./scripts/bench-export.sh benchmark-results/latest"

[tasks."bench:variance"]
description = "Run repeated benchmark exports and summarize median timing variance"
run = "./scripts/bench-variance.sh 3 benchmark-results/variance"
